<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>2026马年大吉 - 新年烟花</title>

<style>
html,body{
	margin:0px;
	width:100%;
	height:100%;
	overflow:hidden;
	background:#000;
}
#canvas {
    position:absolute;
    width:100%;
    height:100%;
    z-index:1; /* 烟花在底层 */
}
.canvas {
    position:absolute;
    width:100%;
    height:100%;
    z-index:2; /* 文字在顶层 */
    pointer-events: none; /* 防止文字层拦截点击 */
}
</style>

</head>
<body>
<!-- 背景烟花层 -->
<canvas id="canvas"></canvas>
<!-- 文字层 -->
<canvas class="canvas"></canvas>

<script>
// ==================== 1. 背景 3D 烟花逻辑 ====================
var canvas = document.getElementById("canvas");
var ctx, cx, cy, seeds, sparks, frames, seedTimer, sparkPics;
var pi = Math.PI;
var gravity = 0.02;
var seedInterval = 5, seedLife = 100;
var playerX=0, playerY=0, playerZ=-25, yaw=0, pitch=0, scale=600;

function initFireworks(){
	ctx = canvas.getContext("2d");
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	cx = canvas.width / 2;
	cy = canvas.height / 2;
	seeds = [];
	sparks = [];
	sparkPics = [];
	frames = 0;
	seedTimer = 0;
	
	var s = "https://cantelope.org/NYE/";
	for(var i=1; i<=10; ++i){
		var img = new Image();
		img.src = s + "spark" + i + ".png";
		sparkPics.push(img);
	}
}

function rasterizePoint(x,y,z){
	var p,d;
	x-=playerX; y-=playerY; z-=playerZ;
	p=Math.atan2(x,z); d=Math.sqrt(x*x+z*z);
	x=Math.sin(p-yaw)*d; z=Math.cos(p-yaw)*d;
	p=Math.atan2(y,z); d=Math.sqrt(y*y+z*z);
	y=Math.sin(p-pitch)*d; z=Math.cos(p-pitch)*d;
	if (z <= 0) return {x:0,y:0,d:-1};
	return { x:cx + x/z*scale, y:cy + y/z*scale, d:Math.sqrt(x*x+y*y+z*z) };
}

function spawnSeed(){
	seeds.push({
		x: -50+Math.random()*100, y: 25, z: -50+Math.random()*100,
		vx: .1-Math.random()*.2, vy: -1.5, vz: .1-Math.random()*.2,
		born: frames
	});
}

function splode(x,y,z){
	var t = 50 + parseInt(Math.random()*100);
	var picIdx = parseInt(Math.random()*10);
	for(var m=0; m<t; ++m){
		var p1=pi*2*Math.random(), p2=pi*Math.random(), v=1+Math.random()*2;
		sparks.push({
			x:x, y:y, z:z,
			vx: Math.sin(p1)*Math.sin(p2)*v, vy: Math.cos(p2)*v, vz: Math.cos(p1)*Math.sin(p2)*v,
			img: sparkPics[picIdx], radius: 25+Math.random()*50, alpha: 1, trail: []
		});
	}
}

function frame(){
	if(frames > 100000) { frames=0; seedTimer=0; }
	frames++;
	
	// 逻辑处理
	if(seedTimer < frames){
		seedTimer = frames + Math.random()*20;
		spawnSeed();
	}
	for(var i=seeds.length-1; i>=0; i--){
		seeds[i].vy += gravity; seeds[i].x += seeds[i].vx; seeds[i].y += seeds[i].vy; seeds[i].z += seeds[i].vz;
		if(frames - seeds[i].born > seedLife){
			splode(seeds[i].x, seeds[i].y, seeds[i].z);
			seeds.splice(i,1);
		}
	}
	for(var i=sparks.length-1; i>=0; i--){
		var s = sparks[i];
		if(s.alpha > 0 && s.radius > 5){
			s.alpha -= 0.01; s.radius /= 1.02; s.vy += gravity;
			s.x += s.vx; s.y += s.vy; s.z += s.vz;
			s.vx /= 1.075; s.vy /= 1.075; s.vz /= 1.075;
		} else { sparks.splice(i,1); }
	}
	// 镜头旋转
	var p = Math.atan2(playerX, playerZ), d = Math.sqrt(playerX*playerX + playerZ*playerZ);
	playerX = Math.sin(p + 0.005) * d; playerZ = Math.cos(p + 0.005) * d;
	yaw = pi + p + 0.005;

	// 绘制
	ctx.clearRect(0,0,canvas.width,canvas.height);
	ctx.fillStyle="#ff8";
	for(var i=0; i<seeds.length; i++){
		var pt = rasterizePoint(seeds[i].x, seeds[i].y, seeds[i].z);
		if(pt.d != -1) ctx.fillRect(pt.x, pt.y, 2, 2);
	}
	for(var i=0; i<sparks.length; i++){
		var s = sparks[i];
		var pt = rasterizePoint(s.x, s.y, s.z);
		if(pt.d != -1){
			var size = s.radius * 200 / (1+pt.d);
			ctx.globalAlpha = s.alpha;
			ctx.drawImage(s.img, pt.x-size/2, pt.y-size/2, size, size);
		}
	}
	ctx.globalAlpha = 1;
	requestAnimationFrame(frame);
}

// ==================== 2. 文字变幻逻辑 (Shape Shifter) ====================
var S = {
  init: function () {
    S.Drawing.init('.canvas');
    // 修改此序列：倒计时 -> 2026 -> 新年快乐 -> 祝福语
    // 注意：末尾没有多余的 '|' 符号，会停留在最后一个词
    S.UI.simulate('#countdown 3|2026|新年快乐|马年大吉|龙马精神|马到成功');

    S.Drawing.loop(function () {
      S.Shape.render();
    });
  }
};

S.Drawing = (function () {
  var canvas, context, renderFn;
  var requestFrame = window.requestAnimationFrame || function(cb) { window.setTimeout(cb, 1000/60); };
  return {
    init: function (el) {
      canvas = document.querySelector(el);
      context = canvas.getContext('2d');
      this.adjustCanvas();
      window.addEventListener('resize', this.adjustCanvas.bind(this));
    },
    loop: function (fn) {
      renderFn = fn;
      this.clearFrame();
      renderFn();
      requestFrame.call(window, this.loop.bind(this));
    },
    adjustCanvas: function () {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    },
    clearFrame: function () {
      context.clearRect(0, 0, canvas.width, canvas.height);
    },
    getArea: function () { return { w: canvas.width, h: canvas.height }; },
    drawCircle: function (p, c) {
      context.fillStyle = c.render();
      context.beginPath();
      context.arc(p.x, p.y, p.z, 0, 2 * Math.PI, true);
      context.fill();
    }
  }
}());

S.UI = (function () {
  var interval, sequence = [], cmd = '#';
  function timedAction(fn, delay, max, reverse) {
    clearInterval(interval);
    var current = reverse ? max : 1;
    fn(current);
    interval = setInterval(function () {
      current = reverse ? current - 1 : current + 1;
      fn(current);
      if ((!reverse && current === max) || (reverse && current === 0)) clearInterval(interval);
    }, delay);
  }

  function performAction(value) {
    sequence = typeof(value) === 'object' ? value : sequence.concat(value.split('|'));
    timedAction(function () {
      var current = sequence.shift();
      if (!current) return;
      if (current[0] === cmd) {
        var action = current.substring(1).split(' ')[0];
        var val = current.split(' ')[1];
        if (action === 'countdown') {
          var count = parseInt(val) || 3;
          timedAction(function (i) {
            if (i === 0) performAction(sequence);
            else S.Shape.switchShape(S.ShapeBuilder.letter(i), true);
          }, 1000, count, true);
        }
      } else {
        S.Shape.switchShape(S.ShapeBuilder.letter(current));
      }
    }, 2500, sequence.length); // 每2.5秒换一个词
  }

  return { simulate: performAction };
}());

S.ShapeBuilder = (function () {
  var gap = 13, shapeCanvas = document.createElement('canvas'), shapeContext = shapeCanvas.getContext('2d');
  function fit() {
    shapeCanvas.width = Math.floor(window.innerWidth / gap) * gap;
    shapeCanvas.height = Math.floor(window.innerHeight / gap) * gap;
    shapeContext.fillStyle = 'red';
    shapeContext.textBaseline = 'middle';
    shapeContext.textAlign = 'center';
  }
  fit();
  window.addEventListener('resize', fit);

  return {
    letter: function (l) {
      var fontSize = 500;
      shapeContext.font = 'bold ' + fontSize + 'px "Microsoft YaHei", sans-serif';
      var s = Math.min(fontSize, (shapeCanvas.width / shapeContext.measureText(l).width) * 0.8 * fontSize, (shapeCanvas.height / fontSize) * 0.45 * fontSize);
      shapeContext.font = 'bold ' + s + 'px "Microsoft YaHei", sans-serif';
      shapeContext.clearRect(0, 0, shapeCanvas.width, shapeCanvas.height);
      shapeContext.fillText(l, shapeCanvas.width / 2, shapeCanvas.height / 2);

      var pixels = shapeContext.getImageData(0, 0, shapeCanvas.width, shapeCanvas.height).data;
      var dots = [];
      for (var y = 0; y < shapeCanvas.height; y += gap) {
        for (var x = 0; x < shapeCanvas.width; x += gap) {
          if (pixels[((x + y * shapeCanvas.width) * 4) + 3] > 0) {
            dots.push(new S.Point({ x: x, y: y }));
          }
        }
      }
      return { dots: dots, w: shapeCanvas.width, h: shapeCanvas.height };
    }
  };
}());

S.Point = function (args) { this.x = args.x; this.y = args.y; this.z = 5; this.a = 1; this.h = 0; };
S.Color = function (r, g, b, a) { this.r = r; this.g = g; this.b = b; this.a = a; };
S.Color.prototype.render = function () { return 'rgba(' + this.r + ',' +  + this.g + ',' + this.b + ',' + this.a + ')'; };

S.Dot = function (x, y) {
  this.p = new S.Point({ x: x, y: y });
  this.e = 0.07; this.s = true;
  this.c = new S.Color(255, 255, 255, this.p.a);
  this.t = new S.Point({ x: x, y: y }); this.q = [];
};

S.Dot.prototype = {
  _draw: function () { this.c.a = this.p.a; S.Drawing.drawCircle(this.p, this.c); },
  _moveTowards: function (n) {
    var dx = this.p.x - n.x, dy = this.p.y - n.y, d = Math.sqrt(dx * dx + dy * dy), e = this.e * d;
    if (d > 1) { this.p.x -= (dx/d)*e; this.p.y -= (dy/d)*e; return false; }
    return true;
  },
  _update: function () {
    if (this._moveTowards(this.t)) {
      var p = this.q.shift();
      if (p) { this.t.x = p.x; this.t.y = p.y; this.t.a = p.a; }
      else if (this.s) { this.p.x -= Math.sin(Math.random() * 3.142); this.p.y -= Math.sin(Math.random() * 3.142); }
    }
    this.p.a += (this.t.a - this.p.a) * 0.05;
  },
  move: function (p) { this.q.push(p); },
  render: function () { this._update(); this._draw(); }
};

S.Shape = (function () {
  var dots = [];
  return {
    switchShape: function (n, fast) {
      var a = S.Drawing.getArea();
      var cx = a.w / 2 - n.w / 2;
      var cy = a.h / 2 - n.h / 2;

      if (n.dots.length > dots.length) {
        for (var d = dots.length; d < n.dots.length; d++) dots.push(new S.Dot(a.w/2, a.h/2));
      }
      for (var i = 0; i < dots.length; i++) {
        if (i < n.dots.length) {
          dots[i].s = true; dots[i].e = fast ? 0.25 : 0.14;
          dots[i].move(new S.Point({ x: n.dots[i].x + cx, y: n.dots[i].y + cy, a: 1 }));
        } else {
          dots[i].s = false;
          dots[i].move(new S.Point({ x: Math.random()*a.w, y: Math.random()*a.h, a: 0 }));
        }
      }
    },
    render: function () { for (var d = 0; d < dots.length; d++) dots[d].render(); }
  };
}());

// 启动
initFireworks();
frame();
S.init();
</script>
</body>
</html>
